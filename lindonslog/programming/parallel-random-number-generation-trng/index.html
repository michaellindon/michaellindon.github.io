<!DOCTYPE html>
<html lang="en-US" prefix="og: http://ogp.me/ns#">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width" />

<link rel="profile" href="http://gmpg.org/xfn/11" />
<link rel="pingback" href="http://www.lindonslog.com/xmlrpc.php" />
<link href='http://fonts.googleapis.com/css?family=Economica:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>
<!--[if lt IE 9]>
<script src="http://www.lindonslog.com/wp-content/themes/Winter/js/html5.js" type="text/javascript"></script>
<![endif]-->


<!-- This site is optimized with the Yoast SEO plugin v3.1.2 - https://yoast.com/wordpress/plugins/seo/ -->
<title>Parallel Random Number Generation using TRNG - Ive Moved</title>
<link rel="canonical" href="https://michaellindon.github.io/" />
<meta property="og:locale" content="en_US" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Parallel Random Number Generation using TRNG - Ive Moved" />
<meta property="og:description" content="To my surprise and disappointment, popular scientific libraries like Boost or GSL provide no native support for parallel random number generation. Recently I came across TRNG, an excellent random number generation library for C++ built specifically with parallel architectures in mind. Over the last few days I&#8217;ve been trawling internet forums and reading discussions about &hellip;" />
<meta property="og:url" content="http://www.lindonslog.com/programming/parallel-random-number-generation-trng/" />
<meta property="og:site_name" content="Ive Moved" />
<meta property="article:section" content="Programming" />
<meta property="article:published_time" content="2013-07-10T17:46:39+00:00" />
<meta property="article:modified_time" content="2013-08-04T16:02:17+00:00" />
<meta property="og:updated_time" content="2013-08-04T16:02:17+00:00" />
<meta property="og:image" content="http://www.lindonslog.com/wp-content/uploads/2013/07/speedup_prunif.png" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:description" content="To my surprise and disappointment, popular scientific libraries like Boost or GSL provide no native support for parallel random number generation. Recently I came across TRNG, an excellent random number generation library for C++ built specifically with parallel architectures in mind. Over the last few days I&#8217;ve been trawling internet forums and reading discussions about [&hellip;]" />
<meta name="twitter:title" content="Parallel Random Number Generation using TRNG - Ive Moved" />
<meta name="twitter:site" content="@lindonslog" />
<meta name="twitter:image" content="http://www.lindonslog.com/wp-content/uploads/2013/07/speedup_prunif.png" />
<meta name="twitter:creator" content="@lindonslog" />
<!-- / Yoast SEO plugin. -->

<link rel='dns-prefetch' href='http://s0.wp.com/' />
<link rel='dns-prefetch' href='http://s.gravatar.com/' />
<link rel='dns-prefetch' href='http://s.w.org/' />
<link rel="alternate" type="application/rss+xml" title="Ive Moved &raquo; Feed" href="../../feed/index.html" />
<link rel="alternate" type="application/rss+xml" title="Ive Moved &raquo; Comments Feed" href="../../comments/feed/index.html" />
<link rel="alternate" type="application/rss+xml" title="Ive Moved &raquo; Parallel Random Number Generation using TRNG Comments Feed" href="feed/index.html" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/www.lindonslog.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.6.1"}};
			!function(a,b,c){function d(a){var c,d,e,f,g,h=b.createElement("canvas"),i=h.getContext&&h.getContext("2d"),j=String.fromCharCode;if(!i||!i.fillText)return!1;switch(i.textBaseline="top",i.font="600 32px Arial",a){case"flag":return i.fillText(j(55356,56806,55356,56826),0,0),!(h.toDataURL().length<3e3)&&(i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,65039,8205,55356,57096),0,0),c=h.toDataURL(),i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,55356,57096),0,0),d=h.toDataURL(),c!==d);case"diversity":return i.fillText(j(55356,57221),0,0),e=i.getImageData(16,16,1,1).data,f=e[0]+","+e[1]+","+e[2]+","+e[3],i.fillText(j(55356,57221,55356,57343),0,0),e=i.getImageData(16,16,1,1).data,g=e[0]+","+e[1]+","+e[2]+","+e[3],f!==g;case"simple":return i.fillText(j(55357,56835),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode8":return i.fillText(j(55356,57135),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode9":return i.fillText(j(55358,56631),0,0),0!==i.getImageData(16,16,1,1).data[0]}return!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i;for(i=Array("simple","flag","unicode8","diversity","unicode9"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='papercite_css-css'  href='../../wp-content/plugins/papercite/papercite.css%3Fver=4.6.1.css' type='text/css' media='all' />
<link rel='stylesheet' id='style-css'  href='../../wp-content/themes/Winter/style.css%3Fver=4.6.1.css' type='text/css' media='all' />
<link rel='stylesheet' id='grid-css'  href='../../wp-content/themes/Winter/css/grid.css%3Fver=4.6.1.css' type='text/css' media='all' />
<link rel='stylesheet' id='wp-style-css'  href='../../wp-content/themes/Winter/css/wp-style.css%3Fver=4.6.1.css' type='text/css' media='all' />
<link rel='stylesheet' id='fontwaesome-css'  href='../../wp-content/themes/Winter/css/font-awesome.css%3Fver=4.6.1.css' type='text/css' media='all' />
<link rel='stylesheet' id='fontwaesome-ie-css'  href='../../wp-content/themes/Winter/css/font-awesome-ie7.css%3Fver=4.6.1.css' type='text/css' media='all' />
<link rel='stylesheet' id='flexslider-css'  href='../../wp-content/themes/Winter/css/flexslider.css%3Fver=4.6.1.css' type='text/css' media='all' />
<link rel='stylesheet' id='fancybox-css'  href='../../wp-content/themes/Winter/css/jquery.fancybox.css%3Fver=4.6.1.css' type='text/css' media='all' />
<link rel='stylesheet' id='genericons-css'  href='../../wp-content/plugins/jetpack/_inc/genericons/genericons/genericons.css%3Fver=3.1.css' type='text/css' media='all' />
<link rel='stylesheet' id='jetpack_css-css'  href='../../wp-content/plugins/jetpack/css/jetpack.css%3Fver=3.9.7.css' type='text/css' media='all' />
<script type='text/javascript' src='../../wp-includes/js/jquery/jquery.js%3Fver=1.12.4'></script>
<script type='text/javascript' src='../../wp-includes/js/jquery/jquery-migrate.min.js%3Fver=1.4.1'></script>
<script type='text/javascript' src='../../wp-content/plugins/papercite/js/papercite.js%3Fver=4.6.1'></script>
<script type='text/javascript' src='../../wp-content/themes/Winter/js/jquery.flexslider-min.js%3Fver=1'></script>
<script type='text/javascript' src='../../wp-content/themes/Winter/js/jquery.fancybox.pack.js%3Fver=1'></script>
<script type='text/javascript' src='../../wp-content/themes/Winter/js/jwplayer.js%3Fver=1'></script>
<script type='text/javascript' src='../../wp-content/themes/Winter/js/custom.js%3Fver=1'></script>
<link rel='https://api.w.org/' href='../../wp-json/index.html' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../../xmlrpc.php%3Frsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="../../wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 4.6.1" />
<link rel='shortlink' href='http://wp.me/p1QEx5-94' />
<link rel="alternate" type="application/json+oembed" href="../../wp-json/oembed/1.0/embed%3Furl=http%253A%252F%252Fwww.lindonslog.com%252Fprogramming%252Fparallel-random-number-generation-trng%252F" />
<link rel="alternate" type="text/xml+oembed" href="../../wp-json/oembed/1.0/embed%3Furl=http%253A%252F%252Fwww.lindonslog.com%252Fprogramming%252Fparallel-random-number-generation-trng%252F&amp;format=xml" />

<link rel='dns-prefetch' href='http://jetpack.wordpress.com/'>
<link rel='dns-prefetch' href='http://s0.wp.com/'>
<link rel='dns-prefetch' href='http://s1.wp.com/'>
<link rel='dns-prefetch' href='http://s2.wp.com/'>
<link rel='dns-prefetch' href='http://public-api.wordpress.com/'>
<link rel='dns-prefetch' href='http://0.gravatar.com/'>
<link rel='dns-prefetch' href='http://1.gravatar.com/'>
<link rel='dns-prefetch' href='http://2.gravatar.com/'>
<link rel='dns-prefetch' href='http://widgets.wp.com/'>
<style type="text/css" id="syntaxhighlighteranchor"></style>
<link rel="icon" href="../../wp-content/uploads/2015/09/cropped-L-32x32.png" sizes="32x32" />
<link rel="icon" href="../../wp-content/uploads/2015/09/cropped-L-192x192.png" sizes="192x192" />
<link rel="apple-touch-icon-precomposed" href="../../wp-content/uploads/2015/09/cropped-L-180x180.png" />
<meta name="msapplication-TileImage" content="http://www.lindonslog.com/wp-content/uploads/2015/09/cropped-L-270x270.png" />

<style id="custom-css-css">.input_prompt{color:#06c}.output_prompt{color:#c00}.prompt{font-family:monospace;font-size:14px}.c,c1{color:#408080;font-style:italic}.k{color:#382;font-weight:700}.kn{color:#382;font-weight:700}.mi{color:#080}.mf{color:#080}.o{color:#96f}.ow{color:#BA22FF;font-weight:700}.nb{color:#382}.n{color:#000}.s,.s1{color:#c22}.se{color:#c22;font-weight:700}.si{color:#C06688;font-weight:700}.nn{color:#4D00FF;font-weight:700}.output_area pre{background-color:#FFF;padding-left:5%}.code_cell{padding-left:1%}.cell{margin-top:10px;margin-bottom:10px}br{line-height:2}.cell h1,h2,h3,h4{margin-top:30px;margin-bottom:10px}</style>
</head>

<body class="single single-post postid-562 single-format-standard">
<div id="page" class="hfeed site">

	<header id="masthead" class="site-header" role="banner">
		<div id="botmenu">
			<div class="container_6">
			<div id="submenu" class="menu-top-container"><ul id="web2feel" class="sfmenu"><li id="menu-item-434" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-434"><a href="../../index.html">About</a></li>
<li id="menu-item-405" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-405"><a href="../../category/mathematics/index.html">Mathematics</a>
<ul class="sub-menu">
	<li id="menu-item-814" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-814"><a href="../../category/mathematics/linear-algebra/index.html">Linear Algebra</a></li>
	<li id="menu-item-406" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-406"><a href="../../category/mathematics/statistics/index.html">Statistics</a></li>
</ul>
</li>
<li id="menu-item-404" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-404"><a href="../../category/linux-unix/index.html">Linux/Unix</a></li>
<li id="menu-item-407" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-has-children menu-item-407"><a href="../../category/programming/index.html">Programming</a>
<ul class="sub-menu">
	<li id="menu-item-408" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-408"><a href="../../category/programming/openmp/index.html">OpenMP</a></li>
	<li id="menu-item-487" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-487"><a href="../../category/programming/r/index.html">R</a></li>
</ul>
</li>
<li id="menu-item-842" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-842"><a href="../../links/index.html">Links</a></li>
</ul></div>			</div>
		</div>
		
		<div class="top cf ">
			<div class="head container_6 cf">
				<div class="logo grid_3">
					
					<h1 class="site-title logo"><a id="blogname" rel="home" href="https://michaellindon.github.io/" title="Ive Moved">Ive Moved</a></h1>
	
					<h2 class="site-description"></h2>
				</div>
				<div class="topbar grid_3">
						<form method="get" id="searchform" action="../../index.html" role="search">
		<label for="s" class="assistive-text">Search</label>
		<input type="text" class="field" name="s" value="" id="s" placeholder="Search &hellip;" />
		<input type="submit" class="submit" name="submit" id="searchsubmit" value="Search" />
	</form>
				</div>
			</div>	
		</div>
	</header><!-- #masthead .site-header -->

	<div id="main" class="site-main container_6">
		<div id="primary" class="content-area">
			<div id="content" class="site-content cf" role="main">

			
				
<article id="post-562" class="grid_6 post-562 post type-post status-publish format-standard hentry category-programming category-r">

<div class="format-box">
<i class="icon-file"></i>
</div>

<div class="post-cover">

	<div class="entry-meta">
		<span class="clock"> <i class="icon-time"></i> 1269 days ago</span> 
		<span class="comments-link"> <i class="icon-comment"></i>  <a href="index.html#comments"><span class="dsq-postid" data-dsqidentifier="562 http://www.lindonslog.com/?p=562">4 Comments</span></a></span>
		<span class="perml"> <i class="icon-bolt"></i> <a href="index.html" rel="bookmark">Permalink</a></span>
	</div><!-- #entry-meta -->
	
	<header class="entry-header">
		<h2 class="entry-title">Parallel Random Number Generation using TRNG</h2>
	</header><!-- .entry-header -->

	<div class="entry-content">
								
								
				<p>To my surprise and disappointment, popular scientific libraries like <a href="http://www.boost.org/doc/libs/1_54_0/doc/html/boost_random.html" title="Random Number Libraries">Boost</a> or <a href="http://www.gnu.org/software/gsl/" title="GNU Scientific Library">GSL</a> provide no native support for parallel random number generation. Recently I came across TRNG, an excellent random number generation library for C++ built specifically with parallel architectures in mind. Over the last few days I&#8217;ve been trawling internet forums and reading discussions about the best parallel random number generation libraries. Given the trend in CPU architectures whereby each contains an ever increasing number of cores, it makes sense to start a project by considering what libraries are available to best make use of this technology. The first libraries I came across were <a href="http://statmath.wu.ac.at/software/RngStreams/doc/rngstreams.html" rel="nofollow">RngStream</a> and <a href="http://www.sprng.org/" title="SPRNG" rel="nofollow">SPRNG</a>. It seems SPRNG was built specifically with MPI, i.e. for distributed memory architectures, in mind and there are some excellent examples and resources of how to get started with <a href="http://darrenjw.wordpress.com/2010/12/14/getting-started-with-parallel-mcmc/" rel="nofollow">parallel MCMC on Darren Wilkinson&#8217;s blog</a>. As a result, it seems a bit contrived to get SPRNG to work with OpenMP, i.e. for shared memory architectures. Moreover, I specifically wanted to use OpenMP because I wanted to write an extension for R for use on personal computers. RngStream is written by the man himself, Pierre L&#8217;Ecuyer, and is much more OpenMP amenable. Both of these, however, only generate uniform pseudo random numbers. This isn&#8217;t a fault, but it means you need to code up transformations and samplers to generate non-uniform pseudo random numbers. While this would be a good exercise, life is short, and I&#8217;d rather leave this sort of thing to the professionals (I don&#8217;t want to code up my own Ziggurat algorithm). Also, the generators or engines are of defined types and I found it hard to convert them into the corresponding types of other libraries like Boost or GSL so that I could use their non-uniform generation code. That probably says more about my ability rather than the actual difficulty of the problem and Darren Wilkinson provides some of his own code for getting the RNG engine of SPRNG into the correct datatype to be compatible with GSL. </p>
<h2>TRNG</h2>
<p>At this point I was quite discouraged but then I came across <a href="http://numbercrunch.de/trng/" title="Tina's Random Number Generator" rel="nofollow">TRNG</a>, written by Heiko Bauke. At first glance TRNG is an excellently documented C++ PRNG (which stands for pseudo random number generator, not parallel, that would be PPRNG) library built specifically with parallel architectures in mind. Not only does it provide non-uniform distributions, but it can be used easily with MPI, OpenMP, CUDA and TBB, for which many examples are supplied. The documentation is excellent and the many examples of the same problem coded with each of the aforementioned parallelization methods are enlightening. If that weren&#8217;t enough, TRNG can be used in combination and interchangeably with the Boost random as well as the C++11 TR1 random libraries, that is, the engines/generators from TRNG can be used with the distribution functions of Boost and C++11 TR1, which was a problem I encountered with RngStream and SPRNG. The way TRNG and RngStream work are slightly different. Whereas RngStream generates multiple independent streams, TRNG uses a single stream and either divides it into blocks, or interleaves it between different processors by a leap-frog type scheme, much like dealing out cards round a table. The point of all this is that the streams of different processors never overlap, otherwise one would get the same draws on processor A as processor B. While purists might argue that  L&#8217;Ecuyer&#8217;s method is more rigorous, I&#8217;m happy enough with the way Heiko has done it, especially given TRNG&#8217;s out-of-box easy of use and compatibility.</p>
<h3>Installation of TRNG</h3>
<p>Clone the repository off Github.</p>
<pre class="brush: bash; title: ; notranslate" title="">
[michael@michael$git clone https://github.com/rabauke/trng4
[michael@michael$cd trng4/
[michael@michael trng4]$./configure --prefix=/usr
[michael@michael trng4]$make
[michael@michael trng4]$make inst
[michael@michael trng4]$ sudo bash
[sudo] password for michael: 
[root@michael trng4]# ldconfig
[root@michael trng4]#
</pre>
<p>the &#8220;&#8211;prefix=&#8221; argument just sets where I want the files to be installed and is not necessary. If omitted the default case is /usr/local. After make install, run ldconfig as root in order to update the dynamic linker/loader with the presence of the new library. </p>
<p>Basically there exists a cache /etc/ld.so.cache which is used by the dynamic linker/loader at run-time as a cross-reference for a library&#8217;s soname with its full file path. ldconfig is normally run during booting but can also be run anytime to update the cache with the locations of new libraries. Here is what happens if you don&#8217;t run ldconfig, as I did the first time.</p>
<pre class="brush: bash; title: ; notranslate" title="">
[michael@michael ~]$ g++ hello_world.cc -L /usr/lib -ltrng4
[michael@michael ~]$ ./a.out
./a.out: error while loading shared libraries: libtrng4.so.0: cannot open shared object file: No such file or directory
</pre>
<p>It compiled fine, but at run-time the loader couldn&#8217;t find the library.</p>
<h2>Parallel Random Number Generation in C++</h2>
<p><strong>Nachtrag:</strong> I think instead of using trng::yarn2 gen[max] it is better to do:</p>
<pre class="brush: cpp; title: ; notranslate" title="">
trng::yarn2 * gen;
gen=new trng::yarn2[max];
</pre>
<p>The approach will be to generate the the PRNGs in C++ and call it from R using <a href="../r/rcpp/index.html" title="Calling C++ from R using Rcpp">Rcpp</a>. First lets consider the C++ code to generate some random uniforms.</p>
<pre class="brush: cpp; title: ; notranslate" title="">
#include &lt;cstdlib&gt;
#include &lt;iostream&gt;
#include &lt;omp.h&gt;
#include &lt;trng/yarn2.hpp&gt;
#include &lt;trng/uniform01_dist.hpp&gt;

int main() {

	int max=omp_get_max_threads();
	omp_set_num_threads(max);
	int rank;
	trng::yarn2 gen[max];
	trng::uniform01_dist&lt;&gt; u;
	std::cout &lt;&lt; max &lt;&lt; &quot; =max num of threads&quot; &lt;&lt; std::endl;


	for (int i = 0; i &lt; max; i++)
	{
		gen[i].split(max,i);
	}


#pragma omp parallel for private(rank)
	for (int i = 0; i &lt; max; ++i)
	{
		rank=omp_get_thread_num();
#pragma omp critical
	std::cout &lt;&lt; u(gen[rank]) &lt;&lt; &quot; from thread &quot; &lt;&lt; rank &lt;&lt;  std::endl;
	}
	return EXIT_SUCCESS;
}

</pre>
<p>which returns</p>
<pre class="brush: bash; title: ; notranslate" title="">
[michael@michael ~]$ g++ omprng.cpp -o omprng -fopenmp -ltrng4
[michael@michael ~]$ ./omprng 
4 =max num of threads
0.919233 from thread 0
0.408994 from thread 1
0.943502 from thread 2
0.401236 from thread 3
[michael@michael ~]$ 
</pre>
<p>The salient feature of this code is the leapfrog process by calling split. There exists a sequence of random uniforms and &#8220;.split(max,i)&#8221; divides it into <em>max</em> subsequences, leap-frogging each other, and grab the <em>i&#8217;th</em> subsequence. You can think of this as <em>max</em> players sitting around a poker table and the .split() as continuously dealing out random uniforms to each of the players. The code says let processor i be &#8220;player&#8221; i and use the sequence of random uniforms dealt to it.</p>
<h2>Parallel Random Number Generation in R using Rcpp</h2>
<p>Thanks to Rcpp the above C++ code can be trivially changed so that it can be used from R. Just include the Rcpp header and change the function return type.</p>
<pre class="brush: bash; title: ; notranslate" title="">
#include &lt;cstdlib&gt;
#include &lt;iostream&gt;
#include &lt;omp.h&gt;
#include &lt;trng/yarn2.hpp&gt;
#include &lt;trng/uniform01_dist.hpp&gt;
#include &lt;Rcpp.h&gt;

// [[Rcpp::export]]
Rcpp::NumericVector prunif(int n) {

	int max=omp_get_max_threads();
	omp_set_num_threads(max);
	int rank;
	trng::yarn2 gen[max];
	trng::uniform01_dist&lt;&gt; u;
	Rcpp::NumericVector draws(n);

	for (int i = 0; i &lt; max; i++)
	{
		gen[i].split(max,i);
	}


#pragma omp parallel for private(rank)
	for (int i = 0; i &lt; n; ++i)
	{
		rank=omp_get_thread_num();
		draws[i]=u(gen[rank]);
	}

	return draws;
}
</pre>
<p>This code can be compiled and loaded into R on the fly, so  lets test it.</p>
<h3>Speedup Performance</h3>
<pre class="brush: r; title: ; notranslate" title="">
&gt; library(Rcpp)
&gt; library(rbenchmark) 
&gt; Sys.setenv(&quot;PKG_CXXFLAGS&quot;=&quot;-fopenmp&quot;)
&gt; Sys.setenv(&quot;PKG_LIBS&quot;=&quot;-ltrng4&quot;)
&gt; sourceCpp(&quot;prunif.cpp&quot;)
&gt; benchmark(replications=rep(100,0,1),runif(1000000),prunif(1000000))
           test replications elapsed relative user.self sys.self user.child
2 prunif(1e+06)          100   0.611     1.00     2.227    0.114          0
1  runif(1e+06)          100   3.837     6.28     3.745    0.086          0
</pre>
<p><div id="attachment_583" style="width: 490px" class="wp-caption aligncenter"><a href="../../wp-content/uploads/2013/07/speedup_prunif.png"><img src="../../wp-content/uploads/2013/07/speedup_prunif.png" alt="Speedup" width="480" height="480" class="size-full wp-image-583" srcset="http://www.lindonslog.com/wp-content/uploads/2013/07/speedup_prunif.png 480w, http://www.lindonslog.com/wp-content/uploads/2013/07/speedup_prunif-150x150.png 150w, http://www.lindonslog.com/wp-content/uploads/2013/07/speedup_prunif-300x300.png 300w" sizes="(max-width: 480px) 100vw, 480px" /></a><p class="wp-caption-text">Parallel RNG speedup</p></div><br />
There are a few things to note. Spawning threads incurs its own overhead, so it will obviously be slower for very few draws. As the number of draws becomes larger the time taken to spawn new threads is dwarfed by the time taken to create the draws and so it is worthwhile to do it in parallel. One caveat is that prunif and runif did not in this case use the same generating algorithm. R&#8217;s algorithm can be changed with RNG.kind and the TRNG algorithm can be changed by using an alternative to yarn in &#8220;trng::yarn2&#8221;. Even if they were the same though I would expect the same qualitative behaviour.</p>
<h2>Discussion</h2>
<p>Generating large samples of random numbers in one hit quickly is not the reason why I started looking for a good parallel random number generator. Rarely is it important to me to generate large amount of draws in one go but it certainly is important to me to have independent streams. Generally I will port expensive parts of my R code, usually for loops, to C++ and inevitably I will somewhere within these for loops or other expensive parts of code need to draw some random numbers. Since these expensive pieces of code are self-evidently <em>expensive</em>, I will want to compute them in parallel in C++ if I can and so it is very important to me to have independent streams from which to draw random numbers.</p>
<div class="sharedaddy sd-sharing-enabled"><div class="robots-nocontent sd-block sd-social sd-social-icon-text sd-sharing"><h3 class="sd-title">Share this:</h3><div class="sd-content"><ul><li class="share-facebook"><a rel="nofollow" data-shared="sharing-facebook-562" class="share-facebook sd-button share-icon" href="index.html%3Fshare=facebook.html" target="_blank" title="Click to share on Facebook"><span>Facebook</span></a></li><li class="share-twitter"><a rel="nofollow" data-shared="sharing-twitter-562" class="share-twitter sd-button share-icon" href="index.html%3Fshare=twitter.html" target="_blank" title="Click to share on Twitter"><span>Twitter</span></a></li><li class="share-google-plus-1"><a rel="nofollow" data-shared="sharing-google-562" class="share-google-plus-1 sd-button share-icon" href="index.html%3Fshare=google-plus-1.html" target="_blank" title="Click to share on Google+"><span>Google</span></a></li><li class="share-end"></li></ul></div></div></div><div class='sharedaddy sd-block sd-like jetpack-likes-widget-wrapper jetpack-likes-widget-unloaded' id='like-post-wrapper-27325203-562-5866bc63904b7' data-src='//widgets.wp.com/likes/#blog_id=27325203&amp;post_id=562&amp;origin=www.lindonslog.com&amp;obj_id=27325203-562-5866bc63904b7' data-name='like-post-frame-27325203-562-5866bc63904b7'><h3 class='sd-title'>Like this:</h3><div class='likes-widget-placeholder post-likes-widget-placeholder' style='height:55px'><span class='button'><span>Like</span></span> <span class="loading">Loading...</span></div><span class='sd-text-color'></span><a class='sd-link-color'></a></div>					</div><!-- .entry-content -->

</div>	

</article><!-- #post-562 -->
				<div class="clear"></div>
				

				
<div id="disqus_thread">
            <div id="dsq-content">


            <ul id="dsq-comments">
                    <li class="comment even thread-even depth-1" id="dsq-comment-169">
        <div id="dsq-comment-header-169" class="dsq-comment-header">
            <cite id="dsq-cite-169">
                <a id="dsq-author-user-169" href="https://github.com/mfasiolo" target="_blank" rel="nofollow">Matteo Fasiolo</a>
            </cite>
        </div>
        <div id="dsq-comment-body-169" class="dsq-comment-body">
            <div id="dsq-comment-message-169" class="dsq-comment-message"><p>Hi Michael, many thanks for sharing this! I wonder how difficult would it be to build a R package that makes all the distributions in TRNG available at R level, by using Rcpp. I guess that would be quite useful, as I don&#8217;t know about any package that provides such functionality.</p>
</div>
        </div>

    <ul class="children">
    <li class="comment byuser comment-author-admin bypostauthor odd alt depth-2" id="dsq-comment-174">
        <div id="dsq-comment-header-174" class="dsq-comment-header">
            <cite id="dsq-cite-174">
                <span id="dsq-author-user-174">admin</span>
            </cite>
        </div>
        <div id="dsq-comment-body-174" class="dsq-comment-body">
            <div id="dsq-comment-message-174" class="dsq-comment-message"><p>Hey Matteo, it would be nice to have a package for parallel random number generation for sure, but it might be possible to achieve this with the C++11 pseudo random number generators instead of TRNG (I wrote this post before I was aware of C++11 PRNG). A lot of people would be happy to have one C++11 PRNG object per thread and seed them differently (i.e. seed according to thread id), this is what I always used to do, but the purists out there I think would say that seeding according to thread id is simply not enough as it may still be possible to get overlapping streams. Having said that, I think in practice the chances of getting an overlapping stream are rare, so you might be willing to accept that risk. I know enough to be cautious, but I don&#8217;t really know enough how best to proceed.</p>
</div>
        </div>

    </li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
    <li class="comment even thread-odd thread-alt depth-1" id="dsq-comment-175">
        <div id="dsq-comment-header-175" class="dsq-comment-header">
            <cite id="dsq-cite-175">
                <a id="dsq-author-user-175" href="https://github.com/mfasiolo" target="_blank" rel="nofollow">Matteo Fasiolo</a>
            </cite>
        </div>
        <div id="dsq-comment-body-175" class="dsq-comment-body">
            <div id="dsq-comment-message-175" class="dsq-comment-message"><p>Actually using one seed per thread is what I generally do too&#8230; but sometimes I do wonder about the hidden risks!</p>
</div>
        </div>

    </li><!-- #comment-## -->
    <li class="comment odd alt thread-even depth-1" id="dsq-comment-676">
        <div id="dsq-comment-header-676" class="dsq-comment-header">
            <cite id="dsq-cite-676">
                <a id="dsq-author-user-676" href="http://blog.x14n.org" target="_blank" rel="nofollow">Helmingstay</a>
            </cite>
        </div>
        <div id="dsq-comment-body-676" class="dsq-comment-body">
            <div id="dsq-comment-message-676" class="dsq-comment-message"><p>Thanks, nice writeup.<br />
Here&#8217;s the best theoretical discussion of threads and rng streams, with a clear discussion of problems and justification for TRNG&#8217;s methodology, FWIW.<br />
<a href="http://arxiv.org/abs/0905.4238" rel="nofollow">http://arxiv.org/abs/0905.4238</a></p>
</div>
        </div>

    </li><!-- #comment-## -->
            </ul>


        </div>

    </div>


			
			</div><!-- #content .site-content -->
		</div><!-- #primary .content-area -->



	</div><!-- #main .site-main -->

<div id="bottom">
<div class="container_6 cf">

<li class="botwid grid_2 widget_categories"><h3 class="bothead">Categories</h3>		<ul>
	<li class="cat-item cat-item-3"><a href="../../category/linux-unix/index.html" >Linux/Unix</a> (16)
</li>
	<li class="cat-item cat-item-5"><a href="../../category/mathematics/index.html" >Mathematics</a> (22)
<ul class='children'>
	<li class="cat-item cat-item-10"><a href="../../category/mathematics/linear-algebra/index.html" >Linear Algebra</a> (5)
</li>
	<li class="cat-item cat-item-7"><a href="../../category/mathematics/statistics/index.html" >Statistics</a> (17)
</li>
</ul>
</li>
	<li class="cat-item cat-item-6"><a href="../../category/programming/index.html" >Programming</a> (24)
<ul class='children'>
	<li class="cat-item cat-item-48"><a href="../../category/programming/clojure/index.html" >clojure</a> (1)
</li>
	<li class="cat-item cat-item-51"><a href="../../category/programming/functional-programming/index.html" >functional programming</a> (1)
</li>
	<li class="cat-item cat-item-50"><a href="../../category/programming/haskell-programming/index.html" >haskell</a> (1)
</li>
	<li class="cat-item cat-item-40"><a href="../../category/programming/julia/index.html" >julia</a> (2)
</li>
	<li class="cat-item cat-item-4"><a href="../../category/programming/openmp/index.html" >OpenMP</a> (6)
</li>
	<li class="cat-item cat-item-11"><a href="../../category/programming/r/index.html" >R</a> (12)
</li>
	<li class="cat-item cat-item-43"><a href="../../category/programming/scala/index.html" >scala</a> (1)
</li>
</ul>
</li>
		</ul>
</li>		<li class="botwid grid_2 widget_recent_entries">		<h3 class="bothead">Recent Posts</h3>		<ul>
					<li>
				<a href="../partial-application-functions-julia/index.html">Partial Application for Functions in Julia</a>
						</li>
					<li>
				<a href="../newtons-iteration-scala-clojure-haskell/index.html">Newtons Iteration in Scala, Clojure and Haskell Comparison</a>
						</li>
					<li>
				<a href="../../mathematics/statistics/mala-metropolis-adjusted-langevin-algorithm-julia/index.html">MALA &#8211; Metropolis Adjusted Langevin Algorithm in Julia</a>
						</li>
					<li>
				<a href="../passing-julia-type-to-c-function-as-struct/index.html">Passing Julia Type to C Function as Struct</a>
						</li>
					<li>
				<a href="../../linux-unix/send-lines-code-vim-r-julia-python-repl-slime/index.html">Send Lines of Code from Vim to R/Julia/Python REPL</a>
						</li>
					<li>
				<a href="../../linux-unix/c-merge-sort-algorithm/index.html">C++ Merge Sort Algorithm</a>
						</li>
					<li>
				<a href="../generate-random-inverse-gaussian-r/index.html">Generate Random Inverse Gaussian in R</a>
						</li>
					<li>
				<a href="../../mathematics/statistics/generalized-double-pareto-shrinkage-priors-sparse-estimation-regression/index.html">Generalized Double Pareto Priors for Regression</a>
						</li>
					<li>
				<a href="../../mathematics/em-algorithm-bayesian-lasso-r-cpp-code/index.html">EM Algorithm for Bayesian Lasso R Cpp Code</a>
						</li>
				</ul>
		</li>			<div class="squarebanner grid_2 cf">
	<h3 class="bothead"> Sponsors </h3>
<ul><li>
<a rel="nofollow" href="index.html" title=""><img src="index.html" alt="" style="vertical-align:bottom;" /></a>
</li>			

<li>
<a rel="nofollow" href="index.html" title=""><img src="index.html" alt="" style="vertical-align:bottom;" /></a>
</li>

<li>
<a rel="nofollow" href="index.html" title=""><img src="index.html" alt="" style="vertical-align:bottom;" /></a>
</li>

<li>
<a rel="nofollow" href="index.html" title=""><img src="index.html" alt="" style="vertical-align:bottom;" /></a>
</li></ul>
</div></div>
</div>


	<footer id="colophon" class="site-footer" role="contentinfo">
	<div class="container_6">
	<div class="site-info">
			<div class="fcred">
			Copyright &copy; 2016 <a href="https://michaellindon.github.io/" title="Ive Moved">Ive Moved</a> - .<br />
 | <a href="https://michaellindon.github.io/" >Ive Moved</a>
			</div>		
		</div><!-- .site-info -->	
		</footer><!-- #colophon .site-footer -->
	
</div><!-- #page .hfeed .site -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-40536457-1', 'lindonslog.com');
  ga('send', 'pageview');

</script><!-- MathJax Latex Plugin installed: Disabled as no shortcodes on this page -->	<div style="display:none">
	</div>
<script type="text/javascript">var elLogo = document.getElementById("ft_logo"); if (elLogo) {elLogo.style.maxHeight = elLogo.getAttribute("relHeight") ? elLogo.getAttribute("relHeight") + "px" : "100px";} if (elLogo) {elLogo.style.maxWidth = elLogo.getAttribute("relWidth") ? elLogo.getAttribute("relWidth") + "px" : "100px";}</script>
	<script type="text/javascript">
		window.WPCOM_sharing_counts = {"http:\/\/www.lindonslog.com\/programming\/parallel-random-number-generation-trng\/":562};
	</script>
		<script type="text/javascript">
			var windowOpen;
		jQuery(document).on( 'ready post-load', function(){
			jQuery( 'a.share-facebook' ).on( 'click', function() {
				if ( 'undefined' !== typeof windowOpen ){ // If there's another sharing window open, close it.
					windowOpen.close();
				}
				windowOpen = window.open( jQuery(this).attr( 'href' ), 'wpcomfacebook', 'menubar=1,resizable=1,width=600,height=400' );
				return false;
			});
		});
		</script>
				<script type="text/javascript">
			var windowOpen;
		jQuery(document).on( 'ready post-load', function(){
			jQuery( 'a.share-twitter' ).on( 'click', function() {
				if ( 'undefined' !== typeof windowOpen ){ // If there's another sharing window open, close it.
					windowOpen.close();
				}
				windowOpen = window.open( jQuery(this).attr( 'href' ), 'wpcomtwitter', 'menubar=1,resizable=1,width=600,height=350' );
				return false;
			});
		});
		</script>
				<script type="text/javascript">
			var windowOpen;
		jQuery(document).on( 'ready post-load', function(){
			jQuery( 'a.share-google-plus-1' ).on( 'click', function() {
				if ( 'undefined' !== typeof windowOpen ){ // If there's another sharing window open, close it.
					windowOpen.close();
				}
				windowOpen = window.open( jQuery(this).attr( 'href' ), 'wpcomgoogle-plus-1', 'menubar=1,resizable=1,width=480,height=550' );
				return false;
			});
		});
		</script>
		<script type='text/javascript' src='../../wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js%3Fver=3.0.9b'></script>
<script type='text/javascript' src='../../wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushBash.js%3Fver=3.0.9b'></script>
<script type='text/javascript' src='../../wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushCpp.js%3Fver=3.0.9b'></script>
<script type='text/javascript' src='../../wp-content/plugins/syntaxhighlighter/third-party-brushes/shBrushR.js%3Fver=20100919'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "http://www.lindonslog.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.9b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "http://www.lindonslog.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.9b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.defaults['toolbar'] = false;
	SyntaxHighlighter.all();
</script>
<script type='text/javascript' src='http://s0.wp.com/wp-content/js/devicepx-jetpack.js?ver=201652'></script>
<script type='text/javascript' src='http://s.gravatar.com/js/gprofiles.js?ver=2016Decaa'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var WPGroHo = {"my_hash":""};
/* ]]> */
</script>
<script type='text/javascript' src='../../wp-content/plugins/jetpack/modules/wpgroho.js%3Fver=4.6.1'></script>
<script type='text/javascript' src='../../wp-content/themes/Winter/js/superfish.js%3Fver=20120206'></script>
<script type='text/javascript' src='../../wp-includes/js/comment-reply.min.js%3Fver=4.6.1'></script>
<script type='text/javascript' src='../../wp-includes/js/wp-embed.min.js%3Fver=4.6.1'></script>
<script type='text/javascript' src='../../wp-content/plugins/jetpack/_inc/postmessage.js%3Fver=3.9.7'></script>
<script type='text/javascript' src='../../wp-content/plugins/jetpack/_inc/jquery.jetpack-resize.js%3Fver=3.9.7'></script>
<script type='text/javascript' src='../../wp-content/plugins/jetpack/_inc/jquery.inview.js%3Fver=3.9.7'></script>
<script type='text/javascript' src='../../wp-content/plugins/jetpack/modules/likes/queuehandler.js%3Fver=3.9.7'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var embedVars = {"disqusConfig":{"platform":"wordpress@4.6.1","language":""},"disqusIdentifier":"562 http:\/\/www.lindonslog.com\/?p=562","disqusShortname":"michaellindon","disqusTitle":"Parallel Random Number Generation using TRNG","disqusUrl":"http:\/\/www.lindonslog.com\/programming\/parallel-random-number-generation-trng\/","options":{"manualSync":false},"postId":"562"};
/* ]]> */
</script>
<script type='text/javascript' src='../../wp-content/plugins/disqus-comment-system/media/js/disqus.js%3Fver=4.6.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var countVars = {"disqusShortname":"michaellindon"};
/* ]]> */
</script>
<script type='text/javascript' src='../../wp-content/plugins/disqus-comment-system/media/js/count.js%3Fver=4.6.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var sharing_js_options = {"lang":"en","counts":"1"};
/* ]]> */
</script>
<script type='text/javascript' src='../../wp-content/plugins/jetpack/modules/sharedaddy/sharing.js%3Fver=3.9.7'></script>
		<iframe src='http://widgets.wp.com/likes/master.html?ver=20151215#ver=20151215' scrolling='no' id='likes-master' name='likes-master' style='display:none;'></iframe>
		<div id='likes-other-gravatars'><div class="likes-text"><span>%d</span> bloggers like this:</div><ul class="wpl-avatars sd-like-gravatars"></ul></div>
		<script type='text/javascript' src='http://stats.wp.com/e-201652.js' async defer></script>
<script type='text/javascript'>
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:3.9.7',blog:'27325203',post:'562',tz:'-4',srv:'www.lindonslog.com'} ]);
	_stq.push([ 'clickTrackerInit', '27325203', '562' ]);
</script>

</body>
</html>
